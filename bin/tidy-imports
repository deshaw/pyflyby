#!/usr/bin/env python3
"""
tidy-imports *.py
tidy-imports < foo.py

Automatically improves python import statements.

  - Adds missing imports and mandatory imports.
  - Removes unused imports.
  - Nicely formats imports (sorts, aligns, wraps).

If filenames are given on the command line, rewrites them.  Otherwise, if
stdin is not a tty, read from stdin and write to stdout.

Top-level and local (within function/class bodies) import statements are
touched by default. Use --no-tidy-local-imports to disable tidying of local
imports.

"""

# pyflyby/tidy-imports
# Copyright (C) 2011, 2012, 2014 Karl Chen.
# License: MIT http://opensource.org/licenses/MIT


from   pyflyby._cmdline         import (_get_pyproj_toml_config, hfmt,
                                        parse_args, process_actions)
from   pyflyby._import_sorting  import sort_imports
from   pyflyby._imports2s       import (canonicalize_imports,
                                        fix_unused_and_missing_imports,
                                        replace_star_imports,
                                        transform_imports)
from   pyflyby._parse           import PythonBlock


def _addopts(parser):
    """
    Callbacks to the parser to fill in extra options.
    """
    parser.add_option('--add-missing',
                        default=True, action='store_true',
                        help=hfmt('''
                            (Default) Add missing imports.'''))
    parser.add_option('--no-add-missing', dest='add_missing',
                        default=True, action='store_false',
                        help=hfmt('''
                            Don't add missing imports.'''))
    parser.add_option('--remove-unused',
                        default="AUTOMATIC", action='store_true',
                        help=hfmt('''
                            Remove unused imports
                            (default unless filename == __init__.py).'''))
    parser.add_option('--no-remove-unused', dest='remove_unused',
                        action='store_false',
                        help=hfmt('''
                            Don't remove unused imports
                            (default if filename == __init__.py).'''))
    parser.add_option('--add-mandatory',
                        default=True, action='store_true',
                        help=hfmt('''
                            (Default) Add mandatory imports.'''))
    parser.add_option('--no-add-mandatory', dest='add_mandatory',
                        default=True, action='store_false',
                        help=hfmt('''
                            Don't add mandatory imports.'''))
    parser.add_option('--replace-star-imports',
                        default=False, action='store_true',
                        help=hfmt('''
                            Replace 'from foo.bar import *' with full list
                            of imports before removing unused imports.'''))
    parser.add_option('--no-replace-star-imports',
                        dest='replace_star_imports',
                        action='store_false',
                        help=hfmt('''
                            (Default) Don't replace 'from foo.bar import
                            *'.'''))
    parser.add_option('--canonicalize',
                        default=True, action='store_true',
                        help=hfmt('''
                            (Default) Replace imports with canonical
                            equivalent imports, according to database.'''))
    parser.add_option('--experimental-sort-imports',
                        default=False, action='store_true',
                        help=hfmt('''
                            experimental import sorting'''))
    parser.add_option('--no-canonicalize', dest='canonicalize',
                        default=True, action='store_false',
                        help=hfmt('''
                            Don't canonicalize imports.'''))
    parser.add_option('--exclude', type='string', dest='exclude',
                        action='append', help=hfmt('Files to exclude from formatting.'))


    def transform_callback(option, opt_str, value, group):
        k, v = value.split("=", 1)
        group.values.transformations[k] = v
    parser.add_option("--transform", action='callback',
                        type="string", callback=transform_callback,
                        metavar="OLD=NEW",
                        dest="transformations", default={},
                        help=hfmt('''
                            Replace OLD with NEW in imports.
                            May be specified multiple times.'''))
    def no_add_callback(option, opt_str, value, group):
        group.values.add_missing = False
        group.values.add_mandatory = False
    parser.add_option('--no-add', action='callback',
                        callback=no_add_callback,
                        help=hfmt('''
                            Equivalent to --no-add-missing
                            --no-add-mandatory.'''))
    parser.add_option('--no-tidy-local-imports', dest='tidy_local_imports',
                        default=True, action='store_false',
                        help=hfmt('''
                            Don't tidy imports within function and class
                            bodies. Temporary until this is considered stable.'''))
def main() -> None:

    config = _get_pyproj_toml_config()
    if config:
        default_config = config.get('tool', {}).get('pyflyby',{})
    else:
        default_config = {}

    def _add_opts_and_defaults(parser):
        _addopts(parser)
        parser.set_defaults(**default_config)

    options, args = parse_args(
        _add_opts_and_defaults,
        import_format_params=True,
        modify_action_params=True,
    )

    def modify(block:PythonBlock) -> PythonBlock:
        if options.transformations:
            block = transform_imports(block, options.transformations,
                                  params=options.params)
        if options.replace_star_imports:
            block = replace_star_imports(block, params=options.params)
        block = fix_unused_and_missing_imports(
            block, params=options.params,
            add_missing=options.add_missing,
            remove_unused=options.remove_unused,
            add_mandatory=options.add_mandatory,
            tidy_local_imports=options.tidy_local_imports,
            )
        # TODO: disable sorting until we figure out #287
        # https://github.com/deshaw/pyflyby/issues/287

        # here we get a (single?) PythonBlock, we can access each statement with
        # >>> block.statements
        # and each statement can have a:
        # is_import
        # or
        # is_comment or blank

        # TODO: we do Python(str(...)) in order to unparse-reparse and get proper ast node numbers.
        if options.experimental_sort_imports:
            sorted_imports = PythonBlock(str(sort_imports(block)))
        else:
            sorted_imports = block
        if options.canonicalize:
            cannonical_imports = canonicalize_imports(sorted_imports, params=options.params)
        else:
            cannonical_imports = sorted_imports
        return cannonical_imports

    cmdline_exclude = getattr(options, "exclude")
    process_actions(
        args,
        options.actions, modify,
        exclude=default_config.get('tidy-imports', {}).get('exclude', []) + (cmdline_exclude if cmdline_exclude else [])
    )


if __name__ == '__main__':
    main()
